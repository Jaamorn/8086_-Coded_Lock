;可将6位密码存储在内存中
;可比较6位密码
;根据比较结果跳转
;新增8255控制led，以及子程序INIT825，DL500MS,DL5S
;新增中断触发更改密码库

	.MODEL	TINY	
CMD_8279	EQU	0BF01H	;8279  CS5
DATA_8279	EQU	0BF00H		
COM_ADD55	EQU	0F003H	;8255  CS1
PA_ADD55	EQU	0F000H
PB_ADD55	EQU	0F001H
PC_ADD55	EQU	0F002H
IO8259_0	EQU	0E000H	;8259 CS2
IO8259_1	EQU	0E001H
ADDR_8155_PA EQU	0C101H	;8155 PA口
ADDR_8155_C	EQU	0C100H	;8155控制口
LINE1	EQU	PA_ADD55	;行线1
LINE2	EQU	PB_ADD55	;行线2
ROW1	EQU	PC_ADD55	;列线1
ROW2	EQU	ADDR_8155_PA;列线2
IO8259_1	EQU	0E001H	
COM_ADDR	EQU	0D003H	;8253 CS3
T0_ADDR		EQU	0D000H
T1_ADDR		EQU	0D001H
T2_ADDR		EQU	0D002H

	.STACK	100	
	.DATA		
;显示器取模
LOCKLOGO DB 00H,00H,0FH,00H,10H,80H,10H,80H,20H,40H,20H,40H,20H,40H,7FH,0E0H
	     DB 7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H
UNLOCKLOGO DB 00H,00H,00H,1CH,00H,22H,00H,22H,00H,41H,00H,41H,00H,41H,7FH,0E0H
		   DB 7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H,7FH,0E0H
NONE   DB 00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
	   DB 00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H,00H
KEYCOUNT	DB  	?
PWCOUNT		DB	?
SWCOUNT		DB	?
LED_TAB		DB	0C0H,0F9H,0A4H,0B0H,99H,92H,82H,0F8H
			DB	080H,90H,88H,83H,0C6H,0A1H,86H,8EH
PW0     	DB 	01H,02H,03H,04H,05H,06H 		;初始密码
PW      	DB 	6 DUP(?)          			;记录密码
PW1			DB	01H,02H,03H,03H,02H,01H
PW2    		DB	06H,05H,04H,03H,02H,01H
PW3			DB	01H,02H,03H,04H,05H,06H
NUM     	DB 	00H               			;记录密码错误次数，起始为零
LOCK_FLAG 	DB 	01H
LED_DATA	DB      01111111B				;密码正确亮绿灯
			DB	10111111B				;待机状态亮黄灯
			DB	11011111B				;密码错误亮红灯
FQ_H	DB	019H					;音调频率，高位
		DB	017H
		DB	015H
		DB	014H
		DB	012H
		DB	011H
		DB	012H
		DB	09H
		DB	08H
		DB	07H	
		DB	07H
		DB	06H
		DB	05H
		DB	05H
FQ_L		DB	012H					;音调频率，低位
		DB	03H
		DB	017H
		DB	032H
		DB	077H
		DB	036H
		DB	013H
		DB	056H
		DB	051H
		DB	058H	
		DB	016H
		DB	038H
		DB	068H
		DB	06H


	.CODE		
START:	MOV	AX,@DATA	
	MOV	DS,AX
	MOV     ES,AX;8259	
	NOP
	CALL	Init8259;8259初始化	
	CALL	WriIntver;8259定义中断向量	
	CALL	INIT_IO;点阵显示初始化
	CALL	INIT8279	;初始化键盘子程序
	CALL	INIT8255	;初始化8255程序
	MOV	KEYCOUNT,0;按键计数
	MOV 	PWCOUNT,0
	MOV 	SWCOUNT,0;切换计数
	MOV	NUM,0;输入的密码次数计数
	CALL	CLEARDISP
	STI	;开中断		
START1:	
	XCHG	CL,LOCK_FLAG
	PUSH CX
	CMP CL,00H
	JNZ DISP_LOCK
START3:	
	CALL	SCAN_KEY	;键扫描
	JNC	START1	;没有按键
	XCHG	AL,KEYCOUNT	
	INC	AL	
	CMP	AL,7	
	JNZ	START2	
	MOV	KEYCOUNT,0
	CALL INIT8279_1; 8个数码块全有字符显示后,再按键,清除显示
	JMP	START1	
START2:	
	XCHG	AL,KEYCOUNT
	MOV CX,0000H
	MOV CX,WORD PTR KEYCOUNT
	SUB CX,0001H
	MOV DI,OFFSET PW
	ADD DI,CX
	AND AL,0FH
    MOV [DI], AL		;[DL]中存入按键
	PUSH	AX
	PUSH	CX
    PUSH	DX
    MOV 	CL,AL
    MOV	DX,COM_ADDR		;8253
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR	
	LEA	BX,FQ_L
	MOV	AL,CL
	XLAT		
	OUT	DX,AL
	LEA	BX,FQ_H
	MOV	AL,CL
	XLAT
	OUT	DX,AL	;	发出按键所对应的声音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL		;延时0.5秒后关闭按键所发出的声音
	POP	DX
	POP	CX
	POP	AX
       
	CALL	KEY_NUM	;键值转换为键号
	LEA	BX,LED_TAB	;字型码表
	XLAT		
	CALL	WRITE_DATA
	CALL	DL500MS
	CMP	CX,5H
        JZ	COMPARE1
	JMP	START1	
START_EXIT:	JMP	$
DISP_LOCK PROC NEAR
	POP CX
	LEA	SI,LOCKLOGO
	CALL	DISP_CH;
	XCHG	CL,LOCK_FLAG
	STC
	JMP START3
DISP_LOCK ENDP
DISP_UNLOCK PROC NEAR
	LEA	SI,UNLOCKLOGO
	CALL	DISP_CH;
	POP CX;恢复lockflag
	XCHG	CL,LOCK_FLAG;恢复CX
	STC
	JMP LOCK12
DISP_UNLOCK ENDP
START11	PROC NEAR
   ;置锁标志位
	PUSH 	AX
	MOV		AL,01H
	XCHG	AL,LOCK_FLAG
	POP  	AX
JMP	START1
START11	ENDP
COMPARE1	PROC	NEAR
JMP	COMPARE
COMPARE1 ENDP
LOCK1	PROC	NEAR
LOCK11:
	
	 XCHG CL,LOCK_FLAG;保护cx
	PUSH CX;保护lockflag
	CMP CL,01H
	JNZ DISP_UNLOCK
LOCK12: 
	CALL	SCAN_KEY	;键扫描
	JNC	LOCK11	;没有按键
	PUSH	AX
    PUSH	CX
    PUSH	DX
	AND AL,0FH
   
    CMP AL,0FH		;扫描键盘，直到按了F键锁上锁
    JNZ LOCK1
    MOV 	CL,AL
    	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,06H
	OUT	DX,AL
	MOV	AL,05H
	OUT	DX,AL	;音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,068H
	OUT	DX,AL
	MOV	AL,05H
	OUT	DX,AL	;音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,038H
	OUT	DX,AL
	MOV	AL,06H
	OUT	DX,AL	;音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL		;以上为上锁音 si la so
	MOV	NUM,0
	POP	DX
	POP	CX
	POP	AX
	JZ      START11
LOCK1	ENDP	
COMPARE	PROC	NEAR
	LEA	SI,PW0	;输入的密码与原密码比较
	LEA	DI,PW
	MOV	CX,7 ;比对6次
	CLD
	REPE	CMPSB
	CMP	CX,0
	JZ	RIGHT
	JNZ	ERROR	
	RET
COMPARE	ENDP		
RIGHT	PROC	NEAR	;密码正确
	PUSH	BX
	PUSH	DX
	PUSH	CX
	;置解锁标志位
	MOV	CL,00H
	XCHG	CL,LOCK_FLAG

	;MOV	CX,4 ;闪烁四次
	;LOOP1:	MOV	AL,0
	;MOV	DX,PA_ADD55
	;LEA	BX,LED_DATA
	;XLAT
	;OUT	DX,AL	;亮绿灯
	;CALL	DL500ms
	;MOV	AX,0FFH
	;OUT	DX,AX
	;CALL	DL500ms
	;LOOP	LOOP1
	CALL	CLEAR
	CALL	DL500MS
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,038H
	OUT	DX,AL
	MOV	AL,06H
	OUT	DX,AL	;音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,068H
	OUT	DX,AL
	MOV	AL,05H
	OUT	DX,AL	;音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,06H
	OUT	DX,AL
	MOV	AL,05H
	OUT	DX,AL	;音
	CALL	DL500ms
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL		;以上为开锁音so la si
	POP  	CX
	POP	BX
	POP	DX
	JMP	LOCK1
	
RIGHT ENDP

ERROR	PROC	NEAR	;密码错误
	PUSH	BX
	PUSH	DX
	PUSH	CX
;	MOV	CX,4
;LOOP2:	MOV	AL,2
;	MOV	DX,PA_ADD55
;	LEA	BX,LED_DATA
;	XLAT
;	OUT	DX,AL	;亮红灯
;	CALL	DL500ms
;	MOV	AX,0FFH
;	OUT	DX,AX
;	CALL	DL500ms
;	LOOP	LOOP2
	CALL	DL500MS
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,012H
	OUT	DX,AL
	MOV	AL,049H
	OUT	DX,AL	;音
	CALL	DL500MS
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL       	;计数器T2为模式3状态，输出方波,BCD码计数
	MOV     DX,T2_ADDR
	MOV	AL,030H
	OUT	DX,AL
	MOV	AL,049H
	OUT	DX,AL	;音
	CALL	DL1S
	MOV	DX,COM_ADDR	
	MOV	AL,10110111B	
	OUT	DX,AL
	CALL	CLEAR
	POP	BX
	POP	DX
	INC	NUM
	CMP	NUM,3
	JZ	ALARM
	JMP	START1
ERROR ENDP
;报警	
ALARM	PROC	NEAR		;8253
	MOV	CX,2
LOOP3:	MOV	DX,COM_ADDR	
	MOV	AL,35H	
	OUT	DX,AL           	;计数器T0设置在模式2状态,BCD码计数
	MOV	DX,T0_ADDR	
	MOV	AL,00H	
	OUT	DX,AL	
	MOV	AL,10H	
	OUT	DX,AL	;CLK0/1000
	MOV	DX,COM_ADDR	
	MOV	AL,77H	
	OUT	DX,AL       	;计数器T1为模式3状态，输出方波,BCD码计数
	MOV     	DX,T1_ADDR	
	MOV	AL,00H	
	OUT	DX,AL	
	MOV	AL,10H	
	OUT	DX,AL	;CLK1/1000
	CALL	DL5S
	MOV	DX,COM_ADDR	
	MOV	AL,77H	
	OUT	DX,AL

	JMP	START
ALARM	ENDP

			
;8279初始化
INIT8279	PROC	NEAR	
	MOV	DX,CMD_8279	;CMD_8279为写命令地址、读状地址
	MOV	AL,34H        ;可编程时钟设置,设置分频系数(20分频）
	OUT	DX,AL	
	MOV	AL,0      ;8*8字符显示,左边输入,外部译码键扫描方式
	OUT	DX,AL	
;	MOV	AL,0A0H	
; 	OUT	DX,AL	
	CALL	INIT8279_1	
	RET		
INIT8279	ENDP		
INIT8279_1	PROC	NEAR	
	CALL	CLEAR	;清显示
	MOV	AL,90H	;从第一个数码管开始移位显示
	OUT	DX,AL	
	RET		
INIT8279_1	ENDP		
CLEAR	PROC	NEAR	
	MOV	DX,CMD_8279	
	MOV	AL,0DEH	; 清除命令
	OUT	DX,AL	
WAIT1:	IN	AL,DX	
	TEST	AL,80H	
	JNZ	WAIT1	; 显示RAM清除完毕吗?
	RET		
CLEAR	ENDP		
SCAN_KEY	PROC	NEAR	
	MOV	DX,CMD_8279	
	IN  	AL,DX	;读状态
READ_FIFO:	AND	AL,7	
	JZ	NO_KEY	;是否有键按下
READ:	MOV	AL,40H	
	OUT	DX,AL	;读FIFO RAM
	MOV	DX,DATA_8279	
	IN	AL,DX	
	STC	;有键	
SCAN_KEY1:	RET		
NO_KEY:	CLC			;无键按下，清CY
	JMP	SCAN_KEY1	
SCAN_KEY ENDP
			
KEY_NUM	PROC	NEAR	
	AND	AL,3FH	
	RET		
KEY_NUM	ENDP
		
WRITE_DATA	PROC	NEAR	
	MOV	DX,DATA_8279	
	OUT	DX,AL
	RET		
WRITE_DATA	ENDP

;初始化8259a
Init8259	PROC		NEAR	


	MOV	DX,IO8259_0	;ICW1写入端口0	
	MOV		AL,13H	;10010B 脉冲触发，单片8259a，不需要icw4
	OUT		DX,AL	
	MOV	DX,IO8259_1	;ICW2写入端口1
	MOV		AL,08H	;00001000B 中断类型号高五位00001
	OUT	DX,AL	
	MOV	AL,09H	

	OUT		DX,AL	
	MOV		AL,0FEH	;11111110B OCW1		2
	OUT		DX,AL	
	RET		
Init8259		ENDP		
WriIntver	PROC		NEAR	
	PUSH		ES	
	MOV	AX,0	
	MOV	ES,AX	
	MOV	DI,20H	
	LEA	AX,INT_0	
	STOSW		
	MOV	AX,CS	
	STOSW		
	POP	ES	
	RET		
WriIntver	ENDP
;初始化8255
INIT8255	PROC	NEAR
	MOV	DX,COM_ADD55
	MOV	AL,80H
	OUT	DX,AL
	MOV	DX,PA_ADD55
	MOV	AL,0FFH
	OUT	DX,AL
	RET
	INIT8255	ENDP
;以下为点阵显示相关函数
INIT_IO		PROC	NEAR	
	MOV	DX,PC_ADD55	;8255控制字地址
	MOV	AL,80H	;设置8255的PA、PB、PC口为输出口
	OUT	DX,AL	;写控制字
	MOV	DX,ADDR_8155_C	;8155控制字地址
	MOV	AL,03H	;设置8155的PA口为输出
	OUT	DX,AL	;写控制字
	RET		
INIT_IO		ENDP			
CLEARDISP PROC	NEAR	
	MOV	AL,0FFH	
	MOV	DX,LINE1	
	OUT	DX,AL	
	MOV	DX,LINE2	
	OUT		DX,AL	
	MOV	AL,0	
	MOV	DX,ROW1	
	OUT	DX,AL	
	MOV	DX,ROW2	
	OUT	DX,AL	
	RET		
CLEARDISP	ENDP
ADJUST	PROC		NEAR	
	PUSH		CX	
	MOV	CX,8	
ADJUST1:	RCL	AL,1	
	XCHG	AL,AH	
	RCR		AL,1	
	XCHG	AL,AH	
	LOOP		ADJUST1	
	MOV		AL,AH	
	POP	CX	
	RET		
ADJUST	ENDP				
DISP_CH	PROC	NEAR	
	PUSH		CX	
	MOV	CX,8	
DISP_CH_1:	CALL	DISP1	
	LOOP		DISP_CH_1	
	POP		CX	
	RET		
DISP_CH	ENDP
DISP1	PROC	NEAR	
	PUSH		SI	
	PUSH		CX	
	MOV	CX,16	;计数器,16列依次被扫描
	MOV		BL,0FEH		;上边列输出值
	MOV	BH,0FFH	;下边列输出值
REPEAT:		MOV		DX,LINE1	
	MOV		AL,BL	
	OUT	DX,AL	;上边列输出
	MOV	DX,LINE2	
	MOV	AL,BH	
	OUT	DX,AL	;下边列输出
	LODSB		
	CALL	ADJUST	;调整AL,将AL中二进制数旋转180度
	MOV	DX,ROW1	
	OUT	DX,AL	;左边行输出
	LODSB		
	CALL	ADJUST	;调整AL,将AL中二进制数旋转180度
	MOV	DX,ROW2	
	OUT		DX,AL	;右边行输出
	CALL	DL10MS	
	CALL		CLEARDISP	
	STC		
	RCL	BL,1	
	RCL	BH,1		;循环移位BX,行线扫描输出0
	LOOP	REPEAT	
	POP	CX	
	POP	SI	
	RET		
DISP1	ENDP

INT_0:	PUSH	DX	
	PUSH	AX	
	XCHG AL,SWCOUNT
	CMP AL,0
	JZ SWITCH1
	CMP AL,1
	JZ SWITCH2
	CMP AL,2
	JZ SWITCH3
	
SWITCH1	PROC	NEAR
	LEA	SI,PW1	;切换为密码组1
	LEA	DI,PW0
	MOV	CX,6
	CLD
	REPE	MOVSB
	INC AL
	XCHG AL,SWCOUNT
	
	MOV	DX,IO8259_0	
	MOV		AL,20H	
	OUT		DX,AL	
	POP	AX	
	POP		DX	
	IRET		
		
	SWITCH1	ENDP
	
	SWITCH2	PROC	NEAR
	LEA	SI,PW2	;切换为密码组2
	LEA	DI,PW0
	MOV	CX,6
	CLD
	REPE	MOVSB
	INC AL
	XCHG AL,SWCOUNT
	
	MOV	DX,IO8259_0	
	MOV		AL,20H	
	OUT		DX,AL	
	POP	AX	
	POP		DX	
	IRET		
		
	SWITCH2	ENDP
	
	SWITCH3	PROC	NEAR
	LEA	SI,PW3	;切换为密码组3
	LEA	DI,PW0
	MOV	CX,6
	CLD
	REPE	MOVSB
	MOV AL,0H
	XCHG AL,SWCOUNT
	



	MOV	DX,IO8259_0	
	MOV		AL,20H	
	OUT		DX,AL	
	POP	AX	
	POP		DX	
	IRET		
		
	SWITCH3	ENDP












	MOV	DX,IO8259_0	
	MOV		AL,20H	
	OUT		DX,AL	






	POP	AX	
	POP		DX	
	IRET

;延时500ms
DL500ms		PROC	NEAR
	PUSH	CX
	MOV	CX,55000
DL500ms1:	LOOP	DL500ms1
	POP	CX
	RET	
DL500ms	ENDP
DL10ms	PROC		NEAR	
	PUSH		CX	
	MOV	CX,133	
	LOOP	$	
	POP		CX	
	RET		
DL10ms	ENDP			
;延时5s
DL5S	PROC	NEAR
	PUSH	CX
	MOV	CX,10
DL5S1:	CALL		DL500ms
	LOOP	DL5S1
	POP	CX
	RET	
	ENDP	
;延时1s
DL1S	PROC	NEAR
	PUSH	CX
	MOV	CX,2
DL1S1:	CALL		DL500ms
	LOOP	DL5S1
	POP	CX
	RET	
	ENDP				
END1:	END	START	






